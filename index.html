<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>数学研究部 | Math Club</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: white;
      overflow-x: hidden;
    }
    nav {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #111;
      color: white;
      padding: 12px 24px;
      z-index: 999;
      font-size: 18px;
      display: flex;
      gap: 20px;
      font-family: "Noto Serif JP", serif;
    }
    nav a {
      color: white;
      text-decoration: none;
    }
    body {
      padding-top: 70px;
    }
    canvas {
      position: fixed;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: -10;
    }
  </style>
</head>

<body>

<nav>
  <a href="index.html">Home</a>
  <a href="schedule.html">Schedule</a>
  <a href="contact.html">Contact</a>
  <a href="qa.html">Q&A</a>
</nav>

<div class="corner-message" style="position:fixed;top:72px;left:20px;font-size:20px;color:#111;font-weight:bold;z-index:10;pointer-events:none;font-family:'Noto Serif JP',serif;">
  京都府立医科大学 数学研究部 公式HP
</div>

<script>
new p5(p => {
  const sideLength = 60;
  const walkerCount = 48;
  let triangles = [];
  let points = [];
  let adjacency = new Map();
  let walkers = [];
  let kpumWalkers = [];
  let boosting = false;
  let kpumTrail;

  p.setup = () => {
    const height = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
    const cnv = p.createCanvas(p.windowWidth, height);
    cnv.position(0, 0);
    cnv.style('z-index', '-10');
    cnv.style('pointer-events', 'none');

    kpumTrail = p.createGraphics(p.width, p.height);
    kpumTrail.clear();

    generateTriangleGrid();
    for (let i = 0; i < walkerCount; i++) {
      walkers.push(new Walker());
    }
    setupKPUM();
  };

  p.draw = () => {
    p.background(255);

    // タイルを描く
    p.noFill();
    p.stroke(0, 40);
    for (let t of triangles) {
      p.beginShape();
      for (let pt of t) {
        p.vertex(pt.x, pt.y);
      }
      p.endShape(p.CLOSE);
    }

    // 通常のWalker
    for (let w of walkers) {
      w.update();
      w.display(0);
    }

    // KPUM Trailに少しずつ白を重ねてフェードアウト
    kpumTrail.fill(255, 255, 255, 3); // ほんの少し白で上書き（←これで7秒くらい残る）
    kpumTrail.noStroke();
    kpumTrail.rect(0, 0, p.width, p.height);

    // KPUMのWalker
    for (let w of kpumWalkers) {
      w.update();
      w.displayTrail(kpumTrail);
    }

    p.image(kpumTrail, 0, 0); // Trailを重ねる
  };

  // ---- Walker, KPUMWalker, その他の関数はそのまま ----

  class KPUMWalker {
    constructor(path) {
      this.path = path;
      this.index = 0;
      this.t = 0;
      this.speed = 0.01;
    }

    update() {
      this.t += this.speed * (boosting ? 2.5 : 1);
      if (this.t >= 1) {
        this.t = 0;
        this.index = (this.index + 1) % this.path.length;
      }
    }

    displayTrail(pg) {
      const a = this.path[this.index];
      const b = this.path[(this.index + 1) % this.path.length];
      const x = p.lerp(a.x, b.x, this.t);
      const y = p.lerp(a.y, b.y, this.t);

      const size = 8;

      pg.noStroke();
      pg.fill(0, 180, 0, 200); // 緑色
      pg.ellipse(x, y, size);
    }
  }

  p.touchStarted = () => { boosting = true; };
  p.touchEnded = () => { boosting = false; };
  p.mousePressed = () => { boosting = true; };
  p.mouseReleased = () => { boosting = false; };

  p.windowResized = () => {
    p.resizeCanvas(p.windowWidth, Math.max(document.body.scrollHeight, document.documentElement.scrollHeight));
    kpumTrail = p.createGraphics(p.width, p.height);
    kpumTrail.clear();
  };
});
</script>

</body>
</html>
